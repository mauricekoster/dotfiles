#! /bin/env bash


# Set to true when going directly to a submenu, so we can exit directly
BACK_TO_EXIT=false

back_to() {
  local parent_menu="$1"

  if [[ "$BACK_TO_EXIT" == "true" ]]; then
    exit 0
  elif [[ -n "$parent_menu" ]]; then
    "$parent_menu"
  else
    show_main_menu
  fi
}


menu() {

    local prompt="$1"
    shift
    MENU=("$@")
    local options=$(IFS=, ; echo "${MENU[*]}")
    # local extra="$3"
    # local preselect="$4"

    # read -r -a args <<<"$extra"

    # if [[ -n "$preselect" ]]; then
    #     local index
    #     index=$(echo -e "$options" | grep -nxF "$preselect" | cut -d: -f1)
    #     if [[ -n "$index" ]]; then
    #     args+=("-a" "$index")
    #     fi
    # fi

    echo -ne "$options" | rofi -dmenu -i -sep , -p "${prompt}…" # "${args[@]}"
}


menu_alt() {

    local prompt="$1"
    local options="$2"
    local extra="$3"
    local preselect="$4"


    echo -ne "$options" | rofi -dmenu -i -p "${prompt}…" -select "$preselect" #"${args[@]}"
}


show_learn_menu() {
  MENU=(
    # "  Keybindings"
    "  MKO"
    # "  Hyprland"
    # "󰣇  Arch"
    "  Neovim"
    "󱆃  Bash"
  )
  case $(menu "Learn" "${MENU[@]}" ) in
  # *Keybindings*) omarchy-menu-keybindings ;;
  *MKO*) mko-launch-webapp "https://www.mauricekoster.com" ;;
  # *Hyprland*) omarchy-launch-webapp "https://wiki.hypr.land/" ;;
  # *Arch*) omarchy-launch-webapp "https://wiki.archlinux.org/title/Main_page" ;;
  *Bash*) mko-launch-webapp "https://devhints.io/bash" ;;
  *Neovim*) mko-launch-webapp "https://www.lazyvim.org/keymaps" ;;
  *) show_main_menu ;;
  esac
}


show_style_menu() {
  MENU=(
    "󰸌  Theme"
    # "  Font"
    # "  Background"
    # "  Hyprland"
    # "󱄄  Screensaver"
    # "  About"
  )
  case $(menu "Style" "${MENU[@]}") in
    *Theme*) show_theme_menu ;;
    *Font*) show_font_menu ;;
    *Background*) omarchy-theme-bg-next ;;
    *Hyprland*) open_in_editor ~/.config/hypr/looknfeel.conf ;;
    *Screensaver*) open_in_editor ~/.config/omarchy/branding/screensaver.txt ;;
    *About*) open_in_editor ~/.config/omarchy/branding/about.txt ;;
    *) show_main_menu ;;
  esac
}

show_theme_menu() {
  theme=$(menu_alt "Theme" "$(mko-theme-list)" "" "$(mko-theme-current)")
  if [[ "$theme" == "CNCLD" || -z "$theme" ]]; then
    back_to show_style_menu
  else
    mko-theme-set "$theme"
  fi
}


show_main_menu() {
  MENU=(
    "󰀻  Apps"
    "󰧑  Learn"
    "󱓞  Trigger"
    "  Style"
    "  Setup"
    "󰉉  Install"
    "󰭌  Remove"
    "  Update"
    "  About"
    "  System"
  )
  go_to_menu "$(menu "Go" "${MENU[@]}")"
}

go_to_menu() {
  case "${1,,}" in
  *apps*) rofi -modi drun,run -show drun ;;
  *learn*) show_learn_menu ;;
  *trigger*) show_trigger_menu ;;
  *share*) show_share_menu ;;
  *style*) show_style_menu ;;
  *theme*) show_theme_menu ;;
  *screenshot*) show_screenshot_menu ;;
  *screenrecord*) show_screenrecord_menu ;;
  *setup*) show_setup_menu ;;
  *power*) show_setup_power_menu ;;
  *install*) show_install_menu ;;
  *remove*) show_remove_menu ;;
  *update*) show_update_menu ;;
  *about*) omarchy-launch-about ;;
  *system*) show_system_menu ;;
  *theme*) show_theme_menu ;;
  esac
}

if [[ -n "$1" ]]; then
  BACK_TO_EXIT=true
  go_to_menu "$1"
else
  show_main_menu
fi